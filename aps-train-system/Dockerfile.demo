FROM node:18-alpine

# Instalar dependencias del sistema
RUN apk add --no-cache \
    postgresql \
    postgresql-client \
    redis \
    nginx \
    supervisor \
    bash \
    wget

# Crear directorios
RUN mkdir -p /app /var/log/supervisor /run/postgresql /run/nginx

# Copiar código
WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .

# Build frontend
RUN npm run build

# Build backend (compilar TypeScript)
RUN npx tsc server.ts --outDir . --module commonjs --target es2020 --esModuleInterop --resolveJsonModule --skipLibCheck

# Configurar Nginx
RUN rm -rf /etc/nginx/http.d/*
RUN echo 'server {' > /etc/nginx/http.d/default.conf && \
    echo '    listen 80;' >> /etc/nginx/http.d/default.conf && \
    echo '    server_name _;' >> /etc/nginx/http.d/default.conf && \
    echo '' >> /etc/nginx/http.d/default.conf && \
    echo '    location / {' >> /etc/nginx/http.d/default.conf && \
    echo '        root /app/dist;' >> /etc/nginx/http.d/default.conf && \
    echo '        try_files $uri $uri/ /index.html;' >> /etc/nginx/http.d/default.conf && \
    echo '    }' >> /etc/nginx/http.d/default.conf && \
    echo '' >> /etc/nginx/http.d/default.conf && \
    echo '    location /api {' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_pass http://localhost:3001;' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_http_version 1.1;' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_set_header Upgrade $http_upgrade;' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_set_header Connection "upgrade";' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_set_header Host $host;' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_cache_bypass $http_upgrade;' >> /etc/nginx/http.d/default.conf && \
    echo '    }' >> /etc/nginx/http.d/default.conf && \
    echo '' >> /etc/nginx/http.d/default.conf && \
    echo '    location /health {' >> /etc/nginx/http.d/default.conf && \
    echo '        proxy_pass http://localhost:3001/health;' >> /etc/nginx/http.d/default.conf && \
    echo '    }' >> /etc/nginx/http.d/default.conf && \
    echo '}' >> /etc/nginx/http.d/default.conf

# Configurar PostgreSQL
RUN mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql /run/postgresql

# Inicializar PostgreSQL
USER postgres
RUN initdb -D /var/lib/postgresql/data
RUN echo "host all all 0.0.0.0/0 trust" >> /var/lib/postgresql/data/pg_hba.conf && \
    echo "listen_addresses='*'" >> /var/lib/postgresql/data/postgresql.conf

USER root

# Script de inicialización
RUN echo '#!/bin/bash' > /app/init.sh && \
    echo 'set -e' >> /app/init.sh && \
    echo '' >> /app/init.sh && \
    echo '# Iniciar PostgreSQL' >> /app/init.sh && \
    echo 'su - postgres -c "pg_ctl -D /var/lib/postgresql/data start"' >> /app/init.sh && \
    echo '' >> /app/init.sh && \
    echo '# Esperar a que PostgreSQL esté listo' >> /app/init.sh && \
    echo 'until su - postgres -c "pg_isready"; do' >> /app/init.sh && \
    echo '  echo "Esperando PostgreSQL..."' >> /app/init.sh && \
    echo '  sleep 1' >> /app/init.sh && \
    echo 'done' >> /app/init.sh && \
    echo '' >> /app/init.sh && \
    echo '# Crear base de datos y usuario' >> /app/init.sh && \
    echo 'su - postgres -c "psql -c \"CREATE USER aps_user WITH PASSWORD '"'"'aps_password'"'"';\""' >> /app/init.sh && \
    echo 'su - postgres -c "psql -c \"CREATE DATABASE aps_train_system OWNER aps_user;\""' >> /app/init.sh && \
    echo '' >> /app/init.sh && \
    echo '# Inicializar schema (si existe)' >> /app/init.sh && \
    echo 'if [ -f /app/database/schema.sql ]; then' >> /app/init.sh && \
    echo '  su - postgres -c "psql -d aps_train_system -f /app/database/schema.sql"' >> /app/init.sh && \
    echo 'fi' >> /app/init.sh && \
    echo '' >> /app/init.sh && \
    echo 'echo "PostgreSQL inicializado correctamente"' >> /app/init.sh && \
    chmod +x /app/init.sh

# Configurar Supervisord
RUN echo '[supervisord]' > /etc/supervisord.conf && \
    echo 'nodaemon=true' >> /etc/supervisord.conf && \
    echo 'logfile=/var/log/supervisor/supervisord.log' >> /etc/supervisord.conf && \
    echo 'pidfile=/var/run/supervisord.pid' >> /etc/supervisord.conf && \
    echo '' >> /etc/supervisord.conf && \
    echo '[program:init]' >> /etc/supervisord.conf && \
    echo 'command=/app/init.sh' >> /etc/supervisord.conf && \
    echo 'autorestart=false' >> /etc/supervisord.conf && \
    echo 'startretries=1' >> /etc/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo '' >> /etc/supervisord.conf && \
    echo '[program:redis]' >> /etc/supervisord.conf && \
    echo 'command=redis-server --bind 0.0.0.0' >> /etc/supervisord.conf && \
    echo 'autostart=true' >> /etc/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo '' >> /etc/supervisord.conf && \
    echo '[program:backend]' >> /etc/supervisord.conf && \
    echo 'command=node /app/server.js' >> /etc/supervisord.conf && \
    echo 'directory=/app' >> /etc/supervisord.conf && \
    echo 'environment=DATABASE_URL="postgresql://aps_user:aps_password@localhost:5432/aps_train_system",REDIS_URL="redis://localhost:6379",PERSISTENCE_MODE="hybrid",NODE_ENV="production",PORT="3001"' >> /etc/supervisord.conf && \
    echo 'autostart=true' >> /etc/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo '' >> /etc/supervisord.conf && \
    echo '[program:nginx]' >> /etc/supervisord.conf && \
    echo 'command=nginx -g "daemon off;"' >> /etc/supervisord.conf && \
    echo 'autostart=true' >> /etc/supervisord.conf && \
    echo 'autorestart=true' >> /etc/supervisord.conf && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisord.conf && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisord.conf && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisord.conf && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisord.conf

EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost/health || exit 1

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]
